import fs from "fs";
import path from "path";
import dotenv from "dotenv";

// Load environment variables
dotenv.config();

const essaysDir = process.env.ESSAYS_DIR;
if (!essaysDir) {
  throw new Error(
    "ESSAYS_DIR environment variable is not set. Please create a .env file with ESSAYS_DIR=/path/to/essays",
  );
}
const staticEssaysDir = path.resolve(process.cwd(), "static/essays");
const staticAssetsEssaysDir = path.resolve(
  process.cwd(),
  "static/assets/essays",
);

// Ensure directories exist
if (!fs.existsSync(staticEssaysDir)) {
  fs.mkdirSync(staticEssaysDir, { recursive: true });
}
if (!fs.existsSync(staticAssetsEssaysDir)) {
  fs.mkdirSync(staticAssetsEssaysDir, { recursive: true });
}

// Copy markdown files
const mdFiles = fs.readdirSync(essaysDir).filter((file) =>
  file.endsWith(".md")
);

console.log(`Copying ${mdFiles.length} essay markdown files...`);
mdFiles.forEach((file) => {
  const srcPath = path.join(essaysDir, file);
  const destPath = path.join(staticEssaysDir, file);
  fs.copyFileSync(srcPath, destPath);
  console.log(`  ✓ ${file}`);
});

// Copy assets directory if it exists (1:1 copy)
const assetsDir = path.join(essaysDir, "assets");
if (fs.existsSync(assetsDir)) {
  console.log("Copying essay assets...");

  const copyRecursive = (src, dest) => {
    const entries = fs.readdirSync(src, { withFileTypes: true });

    for (const entry of entries) {
      const srcPath = path.join(src, entry.name);
      const destPath = path.join(dest, entry.name);

      if (entry.isDirectory()) {
        if (!fs.existsSync(destPath)) {
          fs.mkdirSync(destPath, { recursive: true });
        }
        copyRecursive(srcPath, destPath);
      } else {
        fs.copyFileSync(srcPath, destPath);
      }
    }
  };

  // Simple 1:1 recursive copy of the entire assets directory
  copyRecursive(assetsDir, staticAssetsEssaysDir);
  console.log("  ✓ Assets copied");
}

console.log("✅ Essays copied to static/essays");

// Trigger browser reload by updating a TypeScript file that Vite watches
const reloadTriggerPath = path.resolve(
  process.cwd(),
  "src/lib/essays-reload.ts",
);
const reloadContent =
  `// This file is auto-generated by copy-essays-to-static.mjs
// It triggers Vite HMR when essays are updated
export const ESSAYS_LAST_UPDATE = ${Date.now()};
`;
fs.writeFileSync(reloadTriggerPath, reloadContent, "utf8");
console.log("  ✓ Triggered reload");
