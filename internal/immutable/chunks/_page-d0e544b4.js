import{d as Z}from"./marked-c7288604.js";import{e as lt}from"./index-b40a4f3c.js";import{l as ct,a as rt,b as at,c as ht}from"./load-9bb25164.js";function ft(B,f,g,i,n){var nt,st;const e=B.split(/\r?\n/);let t=0;if(((nt=e[t])==null?void 0:nt.trim())==="---"){for(t++;t<e.length&&((st=e[t])==null?void 0:st.trim())!=="---";)t++;t++}for(;t<e.length&&e[t].trim()==="";)t++;const p=f||(()=>{const $=e[t]||"";return t++,$.replace(/^#\s*/,"").trim()})(),y=g||(()=>{for(;t<e.length&&e[t].trim()==="";)t++;return(e[t]||"").trim()})(),j=p,I=y;if(f||t++,!g){for(;t<e.length&&e[t].trim()==="";)t++;t++}const u=[],r={};let E="",a=null,v=!1,q=[],w=null,x=[],z=!1,A=!1,D="",m=[],d=!1,l=[],W=!1,h=[],S=!1,F=!1,N=[],P=!1,O=[],o=!1,c=[];const M=()=>{if(q.length>0){const $=q.some(b=>b.endsWith("\\"));let s;if($?s=q.map(b=>b.endsWith("\\")?b.slice(0,-1).trim():b.trim()).join("<br>").trim():s=q.join(" ").trim(),s){const b={type:"paragraph",tokens:R(s,i,n)};a?a.content.push(b):o||c.push(b)}}q=[]},J=()=>{if(h.length>0){const $={type:"list",ordered:S,items:h.map(s=>R(s,i,n))};a?a.content.push($):o||c.push($)}h=[],W=!1,S=!1},H=()=>{if(N.length>0){let $,s=[...N];for(let k=s.length-1;k>=0;k--){const T=s[k].trim();if(T){T.startsWith("- ")&&($=Z.parseInline(T.substring(2).trim()),s=s.slice(0,k));break}}s.length===0&&$&&(s=[""]);const b=s.filter(k=>k.trim()!==""),G=b.length>1,K=s.some(k=>k.endsWith("\\"));let _,Q,V=!1,Y;if(K||G){const k=b[b.length-1];V=k?k.endsWith("\\"):!1,Y=b.map(T=>{const U=T.endsWith("\\")?T.slice(0,-1).trim():T.trim();return R(U,i,n)}),_=b.map(T=>T.endsWith("\\")?T.slice(0,-1).trim():T.trim()).join(" ").trim(),Q=!0}else _=s.join(" ").trim(),Q=!1;const L={type:"blockquote",tokens:R(_,i,n),...Y&&{paragraphs:Y},multiline:Q,endsWithBreak:V,...$&&{citation:$}};a?a.content.push(L):o||c.push(L)}N=[],F=!1},X=()=>{if(O.length>=3){const $=K=>{const _=K.split("|").map(Q=>Q.trim());return _[0]===""&&_.shift(),_.length>0&&_[_.length-1]===""&&_.pop(),_},s=$(O[0]),b=O.slice(2).map(K=>$(K)),G={type:"table",headers:s,rows:b};a?a.content.push(G):o||c.push(G)}O=[],P=!1};for(;t<e.length;t++){const $=e[t]??"",s=$.replace(/\t/g,"    ");if(A){if(s.trim()==="```"){const L={type:"code",lang:D,code:m.join(`
`)};a?a.content.push(L):o||c.push(L),A=!1,m=[],D=""}else m.push($);continue}if(d){const L=s.trim().match(/^\$\$(?:\s*\[(\d+)\])?$/);if(L){const k=L[1],U={type:"latex",latex:l.join(`
`).replace(/\\_/g,"_"),...k&&{footnoteRef:k}};a?a.content.push(U):o||c.push(U),d=!1,l=[]}else l.push(s);continue}const b=s.match(/^```(\w*)/);if(b){M(),J(),H(),X(),A=!0,D=b[1]||"";continue}if(s.trim()==="$$"){M(),J(),H(),X(),d=!0;continue}const G=s.match(/^\s*!\[([^\]]*)\]\(([^)]+)\)\s*$/);if(G){M(),J(),H(),X();const L=(G[1]||"").trim(),k=(G[2]||"").trim();let T;if(t+1<e.length){const it=(e[t+1]??"").match(/^\s*[*_](.+)[*_]\s*$/);it&&(T=(it[1]||"").trim(),t++)}const U={type:"image",path:k,alt:L||k,caption:T};a?a.content.push(U):o||c.push(U);continue}const K=s.match(/^##\s+(.*)$/);if(K){M(),J(),H(),X();const L=(K[1]||"").trim();v=/^notes$/i.test(L),v?a=null:(o=!0,a={heading:L,content:[]},u.push(a));continue}if(v){if(s.trim()==="---"){w&&x.length>0&&(r[w]=et(x,i,n),x=[],w=null),z=!0;continue}if(z){E&&(E+=`
`),E+=$;continue}const L=s.match(/^\[(\d+)\]\s*(.*)$/);if(L){w&&x.length>0&&(r[w]=et(x,i,n),x=[]),w=L[1];const k=(L[2]||"").trim();k&&x.push(k)}else w&&s.trim()?x.push(s.trim()):s.trim()===""&&w&&x.push("");continue}const _=s.match(/^\s*(?:-|\*|\+)\s+(.*)/);if(_){W||(M(),W=!0,S=!1),h.push((_[1]||"").trim());continue}const Q=s.match(/^\s*\d+\.\s+(.*)/);if(Q){W||(M(),W=!0,S=!0),h.push((Q[1]||"").trim());continue}const V=s.match(/^\s{2,}(.*)/);if(W&&V&&(V[1]||"").trim()&&h.length>0){const L=h[h.length-1];L.endsWith("\\")?h[h.length-1]=L.slice(0,-1).trim()+"<br>"+(V[1]||"").trim():h[h.length-1]+=" "+(V[1]||"").trim();continue}W&&J();const Y=s.match(/^>\s*(.*)$/);if(Y){F||(M(),F=!0),N.push((Y[1]||"").trim());continue}F&&H();const tt=s.match(/^\s*\|.*\|\s*$/);if(tt&&t+1<e.length){const L=e[t+1]??"";if(/^\s*\|[\s\-:|]+\|\s*$/.test(L)){P||(M(),J(),P=!0),O.push(s.trim());continue}}if(P&&tt){O.push(s.trim());continue}if(P&&X(),s.trim()===""){M();continue}q.push(s.trim())}M(),J(),H(),X(),w&&x.length>0&&(r[w]=et(x,i,n)),!o&&c.length>0?u.push({heading:j,content:c}):o&&c.length>0&&u.unshift({heading:"Foreword",content:c});const C=E?ut(E,i,n):void 0;return{title:j,date:I,sections:u,footnotes:r,contributionNote:C&&C.length>0?C:void 0,audioConfig:i}}function R(B,f,g){const i=[],n=/`([^`\n]+)`/g,e=[];let t;for(;t=n.exec(B);)e.push({start:t.index,end:t.index+t[0].length,code:t[1]});let p=0;for(const y of e){if(y.start>p){const r=B.slice(p,y.start);i.push(...ot(r))}const j=y.code,I=f==null?void 0:f[j],u=(g==null?void 0:g.has(j))??!1;i.push({type:"code",code:j,audio:I,copyable:u}),p=y.end}if(p<B.length){const y=B.slice(p);i.push(...ot(y))}return i}function ot(B){const f=[],g=new RegExp("(\\[\\d+\\])|(?<!\\\\)\\$\\$([^\\n]+?)\\$\\$","g");let i=0,n;for(;n=g.exec(B);){const e=n.index,t=e+n[0].length;if(e>i){const p=B.slice(i,e);f.push({type:"text",text:Z.parseInline(p)})}if(n[1]){const p=n[1].match(/\[(\d+)\]/);p&&f.push({type:"ref",num:p[1]})}else n[2]&&f.push({type:"latex",latex:n[2]});i=t}return i<B.length&&f.push({type:"text",text:Z.parseInline(B.slice(i))}),f}function ut(B,f,g){const i=B.split(/\r?\n/),n=[];let e=[],t=!1,p="",y=[],j=!1,I=[],u=!1,r=[],E=!1,a=!1,v=[],q=!1,w=[];const x=()=>{if(e.length>0){const m=e.some(l=>l.endsWith("\\"));let d;m?d=e.map(l=>l.endsWith("\\")?l.slice(0,-1).trim():l.trim()).join("<br>").trim():d=e.join(" ").trim(),d&&n.push({type:"paragraph",tokens:R(d,f,g)})}e=[]},z=()=>{r.length>0&&n.push({type:"list",ordered:E,items:r.map(m=>R(m,f,g))}),r=[],u=!1,E=!1},A=()=>{if(v.length>0){let m,d=[...v];for(let o=d.length-1;o>=0;o--){const c=d[o].trim();if(c){c.startsWith("- ")&&(m=Z.parseInline(c.substring(2).trim()),d=d.slice(0,o));break}}d.length===0&&m&&(d=[""]);const l=d.filter(o=>o.trim()!==""),W=l.length>1,h=d.some(o=>o.endsWith("\\"));let S,F,N=!1,P;if(h||W){const o=l[l.length-1];N=o?o.endsWith("\\"):!1,P=l.map(c=>{const M=c.endsWith("\\")?c.slice(0,-1).trim():c.trim();return R(M,f,g)}),S=l.map(c=>c.endsWith("\\")?c.slice(0,-1).trim():c.trim()).join(" ").trim(),F=!0}else S=d.join(" ").trim(),F=!1;const O=R(S,f,g);n.push({type:"blockquote",tokens:O,...P&&{paragraphs:P},multiline:F,endsWithBreak:N,...m&&{citation:m}})}v=[],a=!1},D=()=>{if(w.length>=3){const m=W=>{const h=W.split("|").map(S=>S.trim());return h[0]===""&&h.shift(),h.length>0&&h[h.length-1]===""&&h.pop(),h},d=m(w[0]),l=w.slice(2).map(W=>m(W));n.push({type:"table",headers:d,rows:l})}w=[],q=!1};for(let m=0;m<i.length;m++){const d=i[m]??"",l=d.replace(/\t/g,"    ");if(t){l.trim()==="```"?(n.push({type:"code",lang:p,code:y.join(`
`)}),t=!1,y=[],p=""):y.push(d);continue}if(j){const o=l.trim().match(/^\$\$(?:\s*\[(\d+)\])?$/);if(o){const c=o[1],M=I.join(`
`).replace(/\\_/g,"_");n.push({type:"latex",latex:M,...c&&{footnoteRef:c}}),j=!1,I=[]}else I.push(l);continue}const W=l.match(/^```(\w*)/);if(W){x(),z(),A(),D(),t=!0,p=W[1]||"";continue}if(l.trim()==="$$"){x(),z(),A(),D(),j=!0;continue}const h=l.match(/^\s*!\[([^\]]*)\]\(([^)]+)\)\s*$/);if(h){x(),z(),A(),D();const o=(h[1]||"").trim(),c=(h[2]||"").trim();let M;if(m+1<i.length){const H=(i[m+1]??"").match(/^\s*[*_](.+)[*_]\s*$/);H&&(M=(H[1]||"").trim(),m++)}n.push({type:"image",path:c,alt:o||c,caption:M});continue}const S=l.match(/^\s*(?:-|\*|\+)\s+(.*)/);if(S){u||(x(),u=!0,E=!1),r.push((S[1]||"").trim());continue}const F=l.match(/^\s*\d+\.\s+(.*)/);if(F){u||(x(),u=!0,E=!0),r.push((F[1]||"").trim());continue}const N=l.match(/^\s{2,}(.*)/);if(u&&N&&(N[1]||"").trim()&&r.length>0){const o=r[r.length-1];o.endsWith("\\")?r[r.length-1]=o.slice(0,-1).trim()+"<br>"+(N[1]||"").trim():r[r.length-1]+=" "+(N[1]||"").trim();continue}u&&z();const P=l.match(/^>\s*(.*)$/);if(P){a||(x(),a=!0),v.push((P[1]||"").trim());continue}a&&A();const O=l.match(/^\s*\|.*\|\s*$/);if(O&&m+1<i.length){const o=i[m+1]??"";if(/^\s*\|[\s\-:|]+\|\s*$/.test(o)){q||(x(),z(),q=!0),w.push(l.trim());continue}}if(q&&O){w.push(l.trim());continue}if(q&&D(),l.trim()===""){x();continue}e.push(l.trim())}return x(),z(),A(),D(),n}function et(B,f,g){const i=[];let n=[],e=!1,t=[],p=!1;const y=()=>{if(n.length>0){const I=n.some(r=>r.endsWith("\\"));let u;I?u=n.map(r=>r.endsWith("\\")?r.slice(0,-1).trim():r.trim()).join("<br>").trim():u=n.join(" ").trim(),u&&i.push({type:"paragraph",tokens:R(u,f,g)})}n=[]},j=()=>{t.length>0&&i.push({type:"list",ordered:p,items:t.map(I=>R(I,f,g))}),t=[],e=!1,p=!1};for(let I=0;I<B.length;I++){const u=B[I],r=u.match(/^\s*(?:-|\*|\+)\s+(.*)/);if(r){e||(y(),e=!0,p=!1),t.push((r[1]||"").trim());continue}const E=u.match(/^\s*\d+\.\s+(.*)/);if(E){e||(y(),e=!0,p=!0),t.push((E[1]||"").trim());continue}const a=u.match(/^\s{2,}(.*)/);if(e&&a&&(a[1]||"").trim()&&t.length>0){const v=t[t.length-1];v.endsWith("\\")?t[t.length-1]=v.slice(0,-1).trim()+"<br>"+(a[1]||"").trim():t[t.length-1]+=" "+(a[1]||"").trim();continue}if(e&&j(),u.trim()===""){y();continue}n.push(u)}return y(),j(),i}const mt=async({params:B,fetch:f})=>{const{slug:g}=B;try{const n=(await ct(f)).find(j=>j.slug===g);if(!n)throw lt(404,"Essay not found");const e=await rt(g,f),[t,p]=n.hasConfig?await Promise.all([at(g,f),ht(g,f)]):[{},new Set],y=ft(e,n.title,n.date,t,p);return{slug:g,post:y,publish:n.publish}}catch(i){throw i&&typeof i=="object"&&"status"in i?i:lt(404,"Essay not found")}},xt=Object.freeze(Object.defineProperty({__proto__:null,load:mt},Symbol.toStringTag,{value:"Module"}));export{xt as _,mt as l};
