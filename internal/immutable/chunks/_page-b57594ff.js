import{d as E}from"./marked-c7288604.js";import{e as Z}from"./index-b40a4f3c.js";function et(i,s,o,c){var V,X;const n=i.split(/\r?\n/);let t=0;if(((V=n[t])==null?void 0:V.trim())==="---"){for(t++;t<n.length&&((X=n[t])==null?void 0:X.trim())!=="---";)t++;t++}for(;t<n.length&&n[t].trim()==="";)t++;const m=s||(()=>{const r=n[t]||"";return t++,r.replace(/^#\s*/,"").trim()})(),f=o||(()=>{for(;t<n.length&&n[t].trim()==="";)t++;return(n[t]||"").trim()})(),L=m,R=f;if(s||t++,!o){for(;t<n.length&&n[t].trim()==="";)t++;t++}const I=[],U={};let W="",l=null,z=!1,T=[],F=!1,H="",G=[],J=!1,K=[],M=!1,d=[],v=!1,A=!1,N=[],C=!1,_=[],y=!1,g=[];const w=()=>{if(T.length>0){const r=T.some(h=>h.endsWith("\\"));let e;if(r?e=T.map(h=>h.endsWith("\\")?h.slice(0,-1).trim():h.trim()).join("<br>").trim():e=T.join(" ").trim(),e){const h={type:"paragraph",tokens:Q(e,c)};l?l.content.push(h):y||g.push(h)}}T=[]},B=()=>{if(d.length>0){const r={type:"list",ordered:v,items:d.map(e=>Q(e,c))};l?l.content.push(r):y||g.push(r)}d=[],M=!1,v=!1},q=()=>{if(N.length>0){let r,e=[...N];for(let u=e.length-1;u>=0;u--){const b=e[u].trim();if(b){b.startsWith("- ")&&(r=E.parseInline(b.substring(2).trim()),e=e.slice(0,u));break}}e.length===0&&r&&(e=[""]);const h=e.some(u=>u.endsWith("\\"));let x,k,p=!1;if(h){const u=e[e.length-1];p=u?u.endsWith("\\"):!1,x=e.map(b=>{const O=b.endsWith("\\")?b.slice(0,-1).trim():b;return`<span class="blockquote-line">${E.parseInline(O)}</span>`}).join("").trim(),k=!0}else x=E.parseInline(e.join(" ")),k=!1;const j={type:"blockquote",text:x,multiline:k,endsWithBreak:p,...r&&{citation:r}};l?l.content.push(j):y||g.push(j)}N=[],A=!1},S=()=>{if(_.length>=3){const r=k=>{const p=k.split("|").map(j=>j.trim());return p[0]===""&&p.shift(),p.length>0&&p[p.length-1]===""&&p.pop(),p},e=r(_[0]),h=_.slice(2).map(k=>r(k)),x={type:"table",headers:e,rows:h};l?l.content.push(x):y||g.push(x)}_=[],C=!1};for(;t<n.length;t++){const r=n[t]??"",e=r.replace(/\t/g,"    ");if(F){if(e.trim()==="```"){const a={type:"code",lang:H,code:G.join(`
`)};l?l.content.push(a):y||g.push(a),F=!1,G=[],H=""}else G.push(r);continue}if(J){const a=e.trim().match(/^\$\$(?:\s*\[(\d+)\])?$/);if(a){const $=a[1],P={type:"latex",latex:K.join(`
`).replace(/\\_/g,"_"),...$&&{footnoteRef:$}};l?l.content.push(P):y||g.push(P),J=!1,K=[]}else K.push(e);continue}const h=e.match(/^```(\w*)/);if(h){w(),B(),q(),S(),F=!0,H=h[1]||"";continue}if(e.trim()==="$$"){w(),B(),q(),S(),J=!0;continue}const x=e.match(/^\s*!\[([^\]]*)\]\(([^)]+)\)\s*$/);if(x){w(),B(),q(),S();const a=(x[1]||"").trim(),$=(x[2]||"").trim();let D;if(t+1<n.length){const Y=(n[t+1]??"").match(/^\s*[*_](.+)[*_]\s*$/);Y&&(D=(Y[1]||"").trim(),t++)}const P={type:"image",path:$,alt:a||$,caption:D};l?l.content.push(P):y||g.push(P);continue}const k=e.match(/^##\s+(.*)$/);if(k){w(),B(),q(),S();const a=(k[1]||"").trim();z=/^notes$/i.test(a),z?l=null:(y=!0,l={heading:a,content:[]},I.push(l));continue}if(z){const a=e.match(/^\[(\d+)\]\s*(.*)$/);if(a){const $=a[1],D=(a[2]||"").trim();$&&(U[$]=Q(D,c))}else e.trim()&&(W&&(W+=`
`),W+=e);continue}const p=e.match(/^\s*(?:-|\*|\+)\s+(.*)/);if(p){M||(w(),M=!0,v=!1),d.push((p[1]||"").trim());continue}const j=e.match(/^\s*\d+\.\s+(.*)/);if(j){M||(w(),M=!0,v=!0),d.push((j[1]||"").trim());continue}const u=e.match(/^\s{2,}(.*)/);if(M&&u&&(u[1]||"").trim()&&d.length>0){const a=d[d.length-1];a.endsWith("\\")?d[d.length-1]=a.slice(0,-1).trim()+"<br>"+(u[1]||"").trim():d[d.length-1]+=" "+(u[1]||"").trim();continue}M&&B();const b=e.match(/^>\s*(.*)$/);if(b){A||(w(),A=!0),N.push((b[1]||"").trim());continue}A&&q();const O=e.match(/^\s*\|.*\|\s*$/);if(O&&t+1<n.length){const a=n[t+1]??"";if(/^\s*\|[\s\-:|]+\|\s*$/.test(a)){C||(w(),B(),C=!0),_.push(e.trim());continue}}if(C&&O){_.push(e.trim());continue}if(C&&S(),e.trim()===""){w();continue}T.push(e.trim())}return w(),B(),q(),S(),!y&&g.length>0?I.push({heading:L,content:g}):y&&g.length>0&&I.unshift({heading:"Foreword",content:g}),{title:L,date:R,sections:I,footnotes:U,contributionNote:W?E.parse(W):void 0,audioConfig:c}}function Q(i,s){const o=[],c=/`([^`\n]+)`/g,n=[];let t;for(;t=c.exec(i);)n.push({start:t.index,end:t.index+t[0].length,code:t[1]});let m=0;for(const f of n){if(f.start>m){const I=i.slice(m,f.start);o.push(...tt(I))}const L=f.code,R=s==null?void 0:s[L];R?o.push({type:"code",code:L,audio:R}):o.push({type:"text",text:E.parseInline(`\`${L}\``)}),m=f.end}if(m<i.length){const f=i.slice(m);o.push(...tt(f))}return o}function tt(i){const s=[],o=new RegExp("(\\[\\d+\\])|(?<!\\\\)\\$\\$([^\\n]+?)\\$\\$","g");let c=0,n;for(;n=o.exec(i);){const t=n.index,m=t+n[0].length;if(t>c){const f=i.slice(c,t);s.push({type:"text",text:E.parseInline(f)})}if(n[1]){const f=n[1].match(/\[(\d+)\]/);f&&s.push({type:"ref",num:f[1]})}else n[2]&&s.push({type:"latex",latex:n[2]});c=m}return c<i.length&&s.push({type:"text",text:E.parseInline(i.slice(c))}),s}async function nt(i){if(!i)throw new Error("fetch is required to load essay index");const s=await i("/essays/index.json");if(!s.ok)throw new Error("Essay index not found");return await s.json()}async function st(i,s){if(!s)throw new Error("fetch is required to load essay markdown");const o=await s(`/essays/${i}.md`);if(!o.ok)throw new Error(`Essay "${i}" not found`);return await o.text()}async function it(i,s){if(!s)return{};try{const o=await s(`/assets/essays/${i}/config.json`,{headers:{Accept:"application/json"}});return o.ok?(await o.json()).audio||{}:{}}catch{return{}}}const ot=async({params:i,fetch:s})=>{const{slug:o}=i;try{const n=(await nt(s)).find(L=>L.slug===o);if(!n)throw Z(404,"Essay not found");const t=await st(o,s),m=n.hasConfig?await it(o,s):{},f=et(t,n.title,n.date,m);return{slug:o,post:f,publish:n.publish}}catch(c){throw c&&typeof c=="object"&&"status"in c?c:Z(404,"Essay not found")}},rt=Object.freeze(Object.defineProperty({__proto__:null,load:ot},Symbol.toStringTag,{value:"Module"}));export{rt as _,ot as l};
