import{d as Z}from"./marked-c7288604.js";import{e as ot}from"./index-b40a4f3c.js";function rt(h,o,c,i,e){var nt,st;const n=h.split(/\r?\n/);let t=0;if(((nt=n[t])==null?void 0:nt.trim())==="---"){for(t++;t<n.length&&((st=n[t])==null?void 0:st.trim())!=="---";)t++;t++}for(;t<n.length&&n[t].trim()==="";)t++;const g=o||(()=>{const M=n[t]||"";return t++,M.replace(/^#\s*/,"").trim()})(),w=c||(()=>{for(;t<n.length&&n[t].trim()==="";)t++;return(n[t]||"").trim()})(),W=g,E=w;if(o||t++,!c){for(;t<n.length&&n[t].trim()==="";)t++;t++}const m=[],f={};let S="",u=null,D=!1,q=[],$=null,x=[],F=!1,O=!1,z="",d=[],y=!1,l=[],j=!1,p=[],_=!1,R=!1,N=[],P=!1,v=[],r=!1,a=[];const B=()=>{if(q.length>0){const M=q.some(b=>b.endsWith("\\"));let s;if(M?s=q.map(b=>b.endsWith("\\")?b.slice(0,-1).trim():b.trim()).join("<br>").trim():s=q.join(" ").trim(),s){const b={type:"paragraph",tokens:A(s,i,e)};u?u.content.push(b):r||a.push(b)}}q=[]},J=()=>{if(p.length>0){const M={type:"list",ordered:_,items:p.map(s=>A(s,i,e))};u?u.content.push(M):r||a.push(M)}p=[],j=!1,_=!1},H=()=>{if(N.length>0){let M,s=[...N];for(let k=s.length-1;k>=0;k--){const I=s[k].trim();if(I){I.startsWith("- ")&&(M=Z.parseInline(I.substring(2).trim()),s=s.slice(0,k));break}}s.length===0&&M&&(s=[""]);const b=s.filter(k=>k.trim()!==""),G=b.length>1,K=s.some(k=>k.endsWith("\\"));let T,Q,V=!1,Y;if(K||G){const k=b[b.length-1];V=k?k.endsWith("\\"):!1,Y=b.map(I=>{const U=I.endsWith("\\")?I.slice(0,-1).trim():I.trim();return A(U,i,e)}),T=b.map(I=>I.endsWith("\\")?I.slice(0,-1).trim():I.trim()).join(" ").trim(),Q=!0}else T=s.join(" ").trim(),Q=!1;const L={type:"blockquote",tokens:A(T,i,e),...Y&&{paragraphs:Y},multiline:Q,endsWithBreak:V,...M&&{citation:M}};u?u.content.push(L):r||a.push(L)}N=[],R=!1},X=()=>{if(v.length>=3){const M=K=>{const T=K.split("|").map(Q=>Q.trim());return T[0]===""&&T.shift(),T.length>0&&T[T.length-1]===""&&T.pop(),T},s=M(v[0]),b=v.slice(2).map(K=>M(K)),G={type:"table",headers:s,rows:b};u?u.content.push(G):r||a.push(G)}v=[],P=!1};for(;t<n.length;t++){const M=n[t]??"",s=M.replace(/\t/g,"    ");if(O){if(s.trim()==="```"){const L={type:"code",lang:z,code:d.join(`
`)};u?u.content.push(L):r||a.push(L),O=!1,d=[],z=""}else d.push(M);continue}if(y){const L=s.trim().match(/^\$\$(?:\s*\[(\d+)\])?$/);if(L){const k=L[1],U={type:"latex",latex:l.join(`
`).replace(/\\_/g,"_"),...k&&{footnoteRef:k}};u?u.content.push(U):r||a.push(U),y=!1,l=[]}else l.push(s);continue}const b=s.match(/^```(\w*)/);if(b){B(),J(),H(),X(),O=!0,z=b[1]||"";continue}if(s.trim()==="$$"){B(),J(),H(),X(),y=!0;continue}const G=s.match(/^\s*!\[([^\]]*)\]\(([^)]+)\)\s*$/);if(G){B(),J(),H(),X();const L=(G[1]||"").trim(),k=(G[2]||"").trim();let I;if(t+1<n.length){const it=(n[t+1]??"").match(/^\s*[*_](.+)[*_]\s*$/);it&&(I=(it[1]||"").trim(),t++)}const U={type:"image",path:k,alt:L||k,caption:I};u?u.content.push(U):r||a.push(U);continue}const K=s.match(/^##\s+(.*)$/);if(K){B(),J(),H(),X();const L=(K[1]||"").trim();D=/^notes$/i.test(L),D?u=null:(r=!0,u={heading:L,content:[]},m.push(u));continue}if(D){if(s.trim()==="---"){$&&x.length>0&&(f[$]=et(x,i,e),x=[],$=null),F=!0;continue}if(F){S&&(S+=`
`),S+=M;continue}const L=s.match(/^\[(\d+)\]\s*(.*)$/);if(L){$&&x.length>0&&(f[$]=et(x,i,e),x=[]),$=L[1];const k=(L[2]||"").trim();k&&x.push(k)}else $&&s.trim()?x.push(s.trim()):s.trim()===""&&$&&x.push("");continue}const T=s.match(/^\s*(?:-|\*|\+)\s+(.*)/);if(T){j||(B(),j=!0,_=!1),p.push((T[1]||"").trim());continue}const Q=s.match(/^\s*\d+\.\s+(.*)/);if(Q){j||(B(),j=!0,_=!0),p.push((Q[1]||"").trim());continue}const V=s.match(/^\s{2,}(.*)/);if(j&&V&&(V[1]||"").trim()&&p.length>0){const L=p[p.length-1];L.endsWith("\\")?p[p.length-1]=L.slice(0,-1).trim()+"<br>"+(V[1]||"").trim():p[p.length-1]+=" "+(V[1]||"").trim();continue}j&&J();const Y=s.match(/^>\s*(.*)$/);if(Y){R||(B(),R=!0),N.push((Y[1]||"").trim());continue}R&&H();const tt=s.match(/^\s*\|.*\|\s*$/);if(tt&&t+1<n.length){const L=n[t+1]??"";if(/^\s*\|[\s\-:|]+\|\s*$/.test(L)){P||(B(),J(),P=!0),v.push(s.trim());continue}}if(P&&tt){v.push(s.trim());continue}if(P&&X(),s.trim()===""){B();continue}q.push(s.trim())}B(),J(),H(),X(),$&&x.length>0&&(f[$]=et(x,i,e)),!r&&a.length>0?m.push({heading:W,content:a}):r&&a.length>0&&m.unshift({heading:"Foreword",content:a});const C=S?ct(S,i,e):void 0;return{title:W,date:E,sections:m,footnotes:f,contributionNote:C&&C.length>0?C:void 0,audioConfig:i}}function A(h,o,c){const i=[],e=/`([^`\n]+)`/g,n=[];let t;for(;t=e.exec(h);)n.push({start:t.index,end:t.index+t[0].length,code:t[1]});let g=0;for(const w of n){if(w.start>g){const f=h.slice(g,w.start);i.push(...lt(f))}const W=w.code,E=o==null?void 0:o[W],m=(c==null?void 0:c.has(W))??!1;i.push({type:"code",code:W,audio:E,copyable:m}),g=w.end}if(g<h.length){const w=h.slice(g);i.push(...lt(w))}return i}function lt(h){const o=[],c=new RegExp("(\\[\\d+\\])|(?<!\\\\)\\$\\$([^\\n]+?)\\$\\$","g");let i=0,e;for(;e=c.exec(h);){const n=e.index,t=n+e[0].length;if(n>i){const g=h.slice(i,n);o.push({type:"text",text:Z.parseInline(g)})}if(e[1]){const g=e[1].match(/\[(\d+)\]/);g&&o.push({type:"ref",num:g[1]})}else e[2]&&o.push({type:"latex",latex:e[2]});i=t}return i<h.length&&o.push({type:"text",text:Z.parseInline(h.slice(i))}),o}function ct(h,o,c){const i=h.split(/\r?\n/),e=[];let n=[],t=!1,g="",w=[],W=!1,E=[],m=!1,f=[],S=!1,u=!1,D=[],q=!1,$=[];const x=()=>{if(n.length>0){const d=n.some(l=>l.endsWith("\\"));let y;d?y=n.map(l=>l.endsWith("\\")?l.slice(0,-1).trim():l.trim()).join("<br>").trim():y=n.join(" ").trim(),y&&e.push({type:"paragraph",tokens:A(y,o,c)})}n=[]},F=()=>{f.length>0&&e.push({type:"list",ordered:S,items:f.map(d=>A(d,o,c))}),f=[],m=!1,S=!1},O=()=>{if(D.length>0){let d,y=[...D];for(let r=y.length-1;r>=0;r--){const a=y[r].trim();if(a){a.startsWith("- ")&&(d=Z.parseInline(a.substring(2).trim()),y=y.slice(0,r));break}}y.length===0&&d&&(y=[""]);const l=y.filter(r=>r.trim()!==""),j=l.length>1,p=y.some(r=>r.endsWith("\\"));let _,R,N=!1,P;if(p||j){const r=l[l.length-1];N=r?r.endsWith("\\"):!1,P=l.map(a=>{const B=a.endsWith("\\")?a.slice(0,-1).trim():a.trim();return A(B,o,c)}),_=l.map(a=>a.endsWith("\\")?a.slice(0,-1).trim():a.trim()).join(" ").trim(),R=!0}else _=y.join(" ").trim(),R=!1;const v=A(_,o,c);e.push({type:"blockquote",tokens:v,...P&&{paragraphs:P},multiline:R,endsWithBreak:N,...d&&{citation:d}})}D=[],u=!1},z=()=>{if($.length>=3){const d=j=>{const p=j.split("|").map(_=>_.trim());return p[0]===""&&p.shift(),p.length>0&&p[p.length-1]===""&&p.pop(),p},y=d($[0]),l=$.slice(2).map(j=>d(j));e.push({type:"table",headers:y,rows:l})}$=[],q=!1};for(let d=0;d<i.length;d++){const y=i[d]??"",l=y.replace(/\t/g,"    ");if(t){l.trim()==="```"?(e.push({type:"code",lang:g,code:w.join(`
`)}),t=!1,w=[],g=""):w.push(y);continue}if(W){const r=l.trim().match(/^\$\$(?:\s*\[(\d+)\])?$/);if(r){const a=r[1],B=E.join(`
`).replace(/\\_/g,"_");e.push({type:"latex",latex:B,...a&&{footnoteRef:a}}),W=!1,E=[]}else E.push(l);continue}const j=l.match(/^```(\w*)/);if(j){x(),F(),O(),z(),t=!0,g=j[1]||"";continue}if(l.trim()==="$$"){x(),F(),O(),z(),W=!0;continue}const p=l.match(/^\s*!\[([^\]]*)\]\(([^)]+)\)\s*$/);if(p){x(),F(),O(),z();const r=(p[1]||"").trim(),a=(p[2]||"").trim();let B;if(d+1<i.length){const H=(i[d+1]??"").match(/^\s*[*_](.+)[*_]\s*$/);H&&(B=(H[1]||"").trim(),d++)}e.push({type:"image",path:a,alt:r||a,caption:B});continue}const _=l.match(/^\s*(?:-|\*|\+)\s+(.*)/);if(_){m||(x(),m=!0,S=!1),f.push((_[1]||"").trim());continue}const R=l.match(/^\s*\d+\.\s+(.*)/);if(R){m||(x(),m=!0,S=!0),f.push((R[1]||"").trim());continue}const N=l.match(/^\s{2,}(.*)/);if(m&&N&&(N[1]||"").trim()&&f.length>0){const r=f[f.length-1];r.endsWith("\\")?f[f.length-1]=r.slice(0,-1).trim()+"<br>"+(N[1]||"").trim():f[f.length-1]+=" "+(N[1]||"").trim();continue}m&&F();const P=l.match(/^>\s*(.*)$/);if(P){u||(x(),u=!0),D.push((P[1]||"").trim());continue}u&&O();const v=l.match(/^\s*\|.*\|\s*$/);if(v&&d+1<i.length){const r=i[d+1]??"";if(/^\s*\|[\s\-:|]+\|\s*$/.test(r)){q||(x(),F(),q=!0),$.push(l.trim());continue}}if(q&&v){$.push(l.trim());continue}if(q&&z(),l.trim()===""){x();continue}n.push(l.trim())}return x(),F(),O(),z(),e}function et(h,o,c){const i=[];let e=[],n=!1,t=[],g=!1;const w=()=>{if(e.length>0){const E=e.some(f=>f.endsWith("\\"));let m;E?m=e.map(f=>f.endsWith("\\")?f.slice(0,-1).trim():f.trim()).join("<br>").trim():m=e.join(" ").trim(),m&&i.push({type:"paragraph",tokens:A(m,o,c)})}e=[]},W=()=>{t.length>0&&i.push({type:"list",ordered:g,items:t.map(E=>A(E,o,c))}),t=[],n=!1,g=!1};for(let E=0;E<h.length;E++){const m=h[E],f=m.match(/^\s*(?:-|\*|\+)\s+(.*)/);if(f){n||(w(),n=!0,g=!1),t.push((f[1]||"").trim());continue}const S=m.match(/^\s*\d+\.\s+(.*)/);if(S){n||(w(),n=!0,g=!0),t.push((S[1]||"").trim());continue}const u=m.match(/^\s{2,}(.*)/);if(n&&u&&(u[1]||"").trim()&&t.length>0){const D=t[t.length-1];D.endsWith("\\")?t[t.length-1]=D.slice(0,-1).trim()+"<br>"+(u[1]||"").trim():t[t.length-1]+=" "+(u[1]||"").trim();continue}if(n&&W(),m.trim()===""){w();continue}e.push(m)}return w(),W(),i}async function at(h){if(!h)throw new Error("fetch is required to load essay index");const o=await h("/essays/index.json");if(!o.ok)throw new Error("Essay index not found");return await o.json()}async function ht(h,o){if(!o)throw new Error("fetch is required to load essay markdown");const c=await o(`/essays/${h}.md`);if(!c.ok)throw new Error(`Essay "${h}" not found`);return await c.text()}async function ft(h,o){if(!o)return{};try{const c=await o(`/assets/essays/${h}/config.json`,{headers:{Accept:"application/json"}});return c.ok?(await c.json()).audio||{}:{}}catch{return{}}}async function ut(h,o){if(!o)return new Set;try{const c=await o(`/assets/essays/${h}/config.json`,{headers:{Accept:"application/json"}});if(c.ok){const e=(await c.json()).code||[];return new Set(e)}return new Set}catch{return new Set}}const pt=async({params:h,fetch:o})=>{const{slug:c}=h;try{const e=(await at(o)).find(W=>W.slug===c);if(!e)throw ot(404,"Essay not found");const n=await ht(c,o),[t,g]=e.hasConfig?await Promise.all([ft(c,o),ut(c,o)]):[{},new Set],w=rt(n,e.title,e.date,t,g);return{slug:c,post:w,publish:e.publish}}catch(i){throw i&&typeof i=="object"&&"status"in i?i:ot(404,"Essay not found")}},yt=Object.freeze(Object.defineProperty({__proto__:null,load:pt},Symbol.toStringTag,{value:"Module"}));export{yt as _,pt as l};
