import{d as G}from"./marked-c7288604.js";import{e as st}from"./index-b40a4f3c.js";function ot(o,i,r,s){var tt,et;const n=o.split(/\r?\n/);let t=0;if(((tt=n[t])==null?void 0:tt.trim())==="---"){for(t++;t<n.length&&((et=n[t])==null?void 0:et.trim())!=="---";)t++;t++}for(;t<n.length&&n[t].trim()==="";)t++;const u=i||(()=>{const h=n[t]||"";return t++,h.replace(/^#\s*/,"").trim()})(),l=r||(()=>{for(;t<n.length&&n[t].trim()==="";)t++;return(n[t]||"").trim()})(),b=u,y=l;if(i||t++,!r){for(;t<n.length&&n[t].trim()==="";)t++;t++}const f=[],m={};let I="",c=null,q=!1,C=[],M=null,w=[],Z=!1,J=!1,K="",Q=[],U=!1,V=[],W=!1,g=[],A=!1,z=!1,H=[],D=!1,F=[],B=!1,k=[];const $=()=>{if(C.length>0){const h=C.some(p=>p.endsWith("\\"));let e;if(h?e=C.map(p=>p.endsWith("\\")?p.slice(0,-1).trim():p.trim()).join("<br>").trim():e=C.join(" ").trim(),e){const p={type:"paragraph",tokens:v(e,s)};c?c.content.push(p):B||k.push(p)}}C=[]},_=()=>{if(g.length>0){const h={type:"list",ordered:A,items:g.map(e=>v(e,s))};c?c.content.push(h):B||k.push(h)}g=[],W=!1,A=!1},N=()=>{if(H.length>0){let h,e=[...H];for(let x=e.length-1;x>=0;x--){const E=e[x].trim();if(E){E.startsWith("- ")&&(h=G.parseInline(E.substring(2).trim()),e=e.slice(0,x));break}}e.length===0&&h&&(e=[""]);const p=e.some(x=>x.endsWith("\\"));let L,j,d=!1;if(p){const x=e[e.length-1];d=x?x.endsWith("\\"):!1,L=e.map(E=>E.endsWith("\\")?E.slice(0,-1).trim():E.trim()).join("<br>").trim(),j=!0}else L=e.join(" ").trim(),j=!1;const S={type:"blockquote",tokens:v(L,s),multiline:j,endsWithBreak:d,...h&&{citation:h}};c?c.content.push(S):B||k.push(S)}H=[],z=!1},P=()=>{if(F.length>=3){const h=j=>{const d=j.split("|").map(O=>O.trim());return d[0]===""&&d.shift(),d.length>0&&d[d.length-1]===""&&d.pop(),d},e=h(F[0]),p=F.slice(2).map(j=>h(j)),L={type:"table",headers:e,rows:p};c?c.content.push(L):B||k.push(L)}F=[],D=!1};for(;t<n.length;t++){const h=n[t]??"",e=h.replace(/\t/g,"    ");if(J){if(e.trim()==="```"){const a={type:"code",lang:K,code:Q.join(`
`)};c?c.content.push(a):B||k.push(a),J=!1,Q=[],K=""}else Q.push(h);continue}if(U){const a=e.trim().match(/^\$\$(?:\s*\[(\d+)\])?$/);if(a){const T=a[1],R={type:"latex",latex:V.join(`
`).replace(/\\_/g,"_"),...T&&{footnoteRef:T}};c?c.content.push(R):B||k.push(R),U=!1,V=[]}else V.push(e);continue}const p=e.match(/^```(\w*)/);if(p){$(),_(),N(),P(),J=!0,K=p[1]||"";continue}if(e.trim()==="$$"){$(),_(),N(),P(),U=!0;continue}const L=e.match(/^\s*!\[([^\]]*)\]\(([^)]+)\)\s*$/);if(L){$(),_(),N(),P();const a=(L[1]||"").trim(),T=(L[2]||"").trim();let X;if(t+1<n.length){const nt=(n[t+1]??"").match(/^\s*[*_](.+)[*_]\s*$/);nt&&(X=(nt[1]||"").trim(),t++)}const R={type:"image",path:T,alt:a||T,caption:X};c?c.content.push(R):B||k.push(R);continue}const j=e.match(/^##\s+(.*)$/);if(j){$(),_(),N(),P();const a=(j[1]||"").trim();q=/^notes$/i.test(a),q?c=null:(B=!0,c={heading:a,content:[]},f.push(c));continue}if(q){if(e.trim()==="---"){M&&w.length>0&&(m[M]=Y(w,s),w=[],M=null),Z=!0;continue}if(Z){I&&(I+=`
`),I+=e;continue}const a=e.match(/^\[(\d+)\]\s*(.*)$/);if(a){M&&w.length>0&&(m[M]=Y(w,s),w=[]),M=a[1];const T=(a[2]||"").trim();T&&w.push(T)}else M&&e.trim()?w.push(e.trim()):e.trim()===""&&M&&w.push("");continue}const d=e.match(/^\s*(?:-|\*|\+)\s+(.*)/);if(d){W||($(),W=!0,A=!1),g.push((d[1]||"").trim());continue}const O=e.match(/^\s*\d+\.\s+(.*)/);if(O){W||($(),W=!0,A=!0),g.push((O[1]||"").trim());continue}const S=e.match(/^\s{2,}(.*)/);if(W&&S&&(S[1]||"").trim()&&g.length>0){const a=g[g.length-1];a.endsWith("\\")?g[g.length-1]=a.slice(0,-1).trim()+"<br>"+(S[1]||"").trim():g[g.length-1]+=" "+(S[1]||"").trim();continue}W&&_();const x=e.match(/^>\s*(.*)$/);if(x){z||($(),z=!0),H.push((x[1]||"").trim());continue}z&&N();const E=e.match(/^\s*\|.*\|\s*$/);if(E&&t+1<n.length){const a=n[t+1]??"";if(/^\s*\|[\s\-:|]+\|\s*$/.test(a)){D||($(),_(),D=!0),F.push(e.trim());continue}}if(D&&E){F.push(e.trim());continue}if(D&&P(),e.trim()===""){$();continue}C.push(e.trim())}return $(),_(),N(),P(),M&&w.length>0&&(m[M]=Y(w,s)),!B&&k.length>0?f.push({heading:b,content:k}):B&&k.length>0&&f.unshift({heading:"Foreword",content:k}),{title:b,date:y,sections:f,footnotes:m,contributionNote:I?G.parse(I):void 0,audioConfig:s}}function v(o,i){const r=[],s=/`([^`\n]+)`/g,n=[];let t;for(;t=s.exec(o);)n.push({start:t.index,end:t.index+t[0].length,code:t[1]});let u=0;for(const l of n){if(l.start>u){const f=o.slice(u,l.start);r.push(...it(f))}const b=l.code,y=i==null?void 0:i[b];r.push({type:"code",code:b,audio:y}),u=l.end}if(u<o.length){const l=o.slice(u);r.push(...it(l))}return r}function it(o){const i=[],r=new RegExp("(\\[\\d+\\])|(?<!\\\\)\\$\\$([^\\n]+?)\\$\\$","g");let s=0,n;for(;n=r.exec(o);){const t=n.index,u=t+n[0].length;if(t>s){const l=o.slice(s,t);i.push({type:"text",text:G.parseInline(l)})}if(n[1]){const l=n[1].match(/\[(\d+)\]/);l&&i.push({type:"ref",num:l[1]})}else n[2]&&i.push({type:"latex",latex:n[2]});s=u}return s<o.length&&i.push({type:"text",text:G.parseInline(o.slice(s))}),i}function Y(o,i){const r=[];let s=[],n=!1,t=[],u=!1;const l=()=>{if(s.length>0){const y=s.some(m=>m.endsWith("\\"));let f;y?f=s.map(m=>m.endsWith("\\")?m.slice(0,-1).trim():m.trim()).join("<br>").trim():f=s.join(" ").trim(),f&&r.push({type:"paragraph",tokens:v(f,i)})}s=[]},b=()=>{t.length>0&&r.push({type:"list",ordered:u,items:t.map(y=>v(y,i))}),t=[],n=!1,u=!1};for(let y=0;y<o.length;y++){const f=o[y],m=f.match(/^\s*(?:-|\*|\+)\s+(.*)/);if(m){n||(l(),n=!0,u=!1),t.push((m[1]||"").trim());continue}const I=f.match(/^\s*\d+\.\s+(.*)/);if(I){n||(l(),n=!0,u=!0),t.push((I[1]||"").trim());continue}const c=f.match(/^\s{2,}(.*)/);if(n&&c&&(c[1]||"").trim()&&t.length>0){const q=t[t.length-1];q.endsWith("\\")?t[t.length-1]=q.slice(0,-1).trim()+"<br>"+(c[1]||"").trim():t[t.length-1]+=" "+(c[1]||"").trim();continue}if(n&&b(),f.trim()===""){l();continue}s.push(f)}return l(),b(),r}async function rt(o){if(!o)throw new Error("fetch is required to load essay index");const i=await o("/essays/index.json");if(!i.ok)throw new Error("Essay index not found");return await i.json()}async function ct(o,i){if(!i)throw new Error("fetch is required to load essay markdown");const r=await i(`/essays/${o}.md`);if(!r.ok)throw new Error(`Essay "${o}" not found`);return await r.text()}async function lt(o,i){if(!i)return{};try{const r=await i(`/assets/essays/${o}/config.json`,{headers:{Accept:"application/json"}});return r.ok?(await r.json()).audio||{}:{}}catch{return{}}}const at=async({params:o,fetch:i})=>{const{slug:r}=o;try{const n=(await rt(i)).find(b=>b.slug===r);if(!n)throw st(404,"Essay not found");const t=await ct(r,i),u=n.hasConfig?await lt(r,i):{},l=ot(t,n.title,n.date,u);return{slug:r,post:l,publish:n.publish}}catch(s){throw s&&typeof s=="object"&&"status"in s?s:st(404,"Essay not found")}},pt=Object.freeze(Object.defineProperty({__proto__:null,load:at},Symbol.toStringTag,{value:"Module"}));export{pt as _,at as l};
