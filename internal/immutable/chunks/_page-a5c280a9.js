import{d as X}from"./marked-c7288604.js";import{e as it}from"./index-b40a4f3c.js";function lt(f,i,c,n){var et,nt;const e=f.split(/\r?\n/);let t=0;if(((et=e[t])==null?void 0:et.trim())==="---"){for(t++;t<e.length&&((nt=e[t])==null?void 0:nt.trim())!=="---";)t++;t++}for(;t<e.length&&e[t].trim()==="";)t++;const k=i||(()=>{const w=e[t]||"";return t++,w.replace(/^#\s*/,"").trim()})(),p=c||(()=>{for(;t<e.length&&e[t].trim()==="";)t++;return(e[t]||"").trim()})(),E=k,j=p;if(i||t++,!c){for(;t<e.length&&e[t].trim()==="";)t++;t++}const m=[],h={};let I="",a=null,P=!1,q=[],M=null,x=[],R=!1,C=!1,D="",d=[],g=!1,o=[],$=!1,u=[],_=!1,v=!1,S=[],N=!1,F=[],l=!1,r=[];const B=()=>{if(q.length>0){const w=q.some(b=>b.endsWith("\\"));let s;if(w?s=q.map(b=>b.endsWith("\\")?b.slice(0,-1).trim():b.trim()).join("<br>").trim():s=q.join(" ").trim(),s){const b={type:"paragraph",tokens:O(s,n)};a?a.content.push(b):l||r.push(b)}}q=[]},H=()=>{if(u.length>0){const w={type:"list",ordered:_,items:u.map(s=>O(s,n))};a?a.content.push(w):l||r.push(w)}u=[],$=!1,_=!1},A=()=>{if(S.length>0){let w,s=[...S];for(let y=s.length-1;y>=0;y--){const W=s[y].trim();if(W){W.startsWith("- ")&&(w=X.parseInline(W.substring(2).trim()),s=s.slice(0,y));break}}s.length===0&&w&&(s=[""]);const b=s.filter(y=>y.trim()!==""),z=b.length>1,G=s.some(y=>y.endsWith("\\"));let T,J,Q=!1,V;if(G||z){const y=b[b.length-1];Q=y?y.endsWith("\\"):!1,V=b.map(W=>{const K=W.endsWith("\\")?W.slice(0,-1).trim():W.trim();return O(K,n)}),T=b.map(W=>W.endsWith("\\")?W.slice(0,-1).trim():W.trim()).join(" ").trim(),J=!0}else T=s.join(" ").trim(),J=!1;const L={type:"blockquote",tokens:O(T,n),...V&&{paragraphs:V},multiline:J,endsWithBreak:Q,...w&&{citation:w}};a?a.content.push(L):l||r.push(L)}S=[],v=!1},U=()=>{if(F.length>=3){const w=G=>{const T=G.split("|").map(J=>J.trim());return T[0]===""&&T.shift(),T.length>0&&T[T.length-1]===""&&T.pop(),T},s=w(F[0]),b=F.slice(2).map(G=>w(G)),z={type:"table",headers:s,rows:b};a?a.content.push(z):l||r.push(z)}F=[],N=!1};for(;t<e.length;t++){const w=e[t]??"",s=w.replace(/\t/g,"    ");if(C){if(s.trim()==="```"){const L={type:"code",lang:D,code:d.join(`
`)};a?a.content.push(L):l||r.push(L),C=!1,d=[],D=""}else d.push(w);continue}if(g){const L=s.trim().match(/^\$\$(?:\s*\[(\d+)\])?$/);if(L){const y=L[1],K={type:"latex",latex:o.join(`
`).replace(/\\_/g,"_"),...y&&{footnoteRef:y}};a?a.content.push(K):l||r.push(K),g=!1,o=[]}else o.push(s);continue}const b=s.match(/^```(\w*)/);if(b){B(),H(),A(),U(),C=!0,D=b[1]||"";continue}if(s.trim()==="$$"){B(),H(),A(),U(),g=!0;continue}const z=s.match(/^\s*!\[([^\]]*)\]\(([^)]+)\)\s*$/);if(z){B(),H(),A(),U();const L=(z[1]||"").trim(),y=(z[2]||"").trim();let W;if(t+1<e.length){const st=(e[t+1]??"").match(/^\s*[*_](.+)[*_]\s*$/);st&&(W=(st[1]||"").trim(),t++)}const K={type:"image",path:y,alt:L||y,caption:W};a?a.content.push(K):l||r.push(K);continue}const G=s.match(/^##\s+(.*)$/);if(G){B(),H(),A(),U();const L=(G[1]||"").trim();P=/^notes$/i.test(L),P?a=null:(l=!0,a={heading:L,content:[]},m.push(a));continue}if(P){if(s.trim()==="---"){M&&x.length>0&&(h[M]=tt(x,n),x=[],M=null),R=!0;continue}if(R){I&&(I+=`
`),I+=w;continue}const L=s.match(/^\[(\d+)\]\s*(.*)$/);if(L){M&&x.length>0&&(h[M]=tt(x,n),x=[]),M=L[1];const y=(L[2]||"").trim();y&&x.push(y)}else M&&s.trim()?x.push(s.trim()):s.trim()===""&&M&&x.push("");continue}const T=s.match(/^\s*(?:-|\*|\+)\s+(.*)/);if(T){$||(B(),$=!0,_=!1),u.push((T[1]||"").trim());continue}const J=s.match(/^\s*\d+\.\s+(.*)/);if(J){$||(B(),$=!0,_=!0),u.push((J[1]||"").trim());continue}const Q=s.match(/^\s{2,}(.*)/);if($&&Q&&(Q[1]||"").trim()&&u.length>0){const L=u[u.length-1];L.endsWith("\\")?u[u.length-1]=L.slice(0,-1).trim()+"<br>"+(Q[1]||"").trim():u[u.length-1]+=" "+(Q[1]||"").trim();continue}$&&H();const V=s.match(/^>\s*(.*)$/);if(V){v||(B(),v=!0),S.push((V[1]||"").trim());continue}v&&A();const Z=s.match(/^\s*\|.*\|\s*$/);if(Z&&t+1<e.length){const L=e[t+1]??"";if(/^\s*\|[\s\-:|]+\|\s*$/.test(L)){N||(B(),H(),N=!0),F.push(s.trim());continue}}if(N&&Z){F.push(s.trim());continue}if(N&&U(),s.trim()===""){B();continue}q.push(s.trim())}B(),H(),A(),U(),M&&x.length>0&&(h[M]=tt(x,n)),!l&&r.length>0?m.push({heading:E,content:r}):l&&r.length>0&&m.unshift({heading:"Foreword",content:r});const Y=I?ct(I,n):void 0;return{title:E,date:j,sections:m,footnotes:h,contributionNote:Y&&Y.length>0?Y:void 0,audioConfig:n}}function O(f,i){const c=[],n=/`([^`\n]+)`/g,e=[];let t;for(;t=n.exec(f);)e.push({start:t.index,end:t.index+t[0].length,code:t[1]});let k=0;for(const p of e){if(p.start>k){const m=f.slice(k,p.start);c.push(...ot(m))}const E=p.code,j=i==null?void 0:i[E];c.push({type:"code",code:E,audio:j}),k=p.end}if(k<f.length){const p=f.slice(k);c.push(...ot(p))}return c}function ot(f){const i=[],c=new RegExp("(\\[\\d+\\])|(?<!\\\\)\\$\\$([^\\n]+?)\\$\\$","g");let n=0,e;for(;e=c.exec(f);){const t=e.index,k=t+e[0].length;if(t>n){const p=f.slice(n,t);i.push({type:"text",text:X.parseInline(p)})}if(e[1]){const p=e[1].match(/\[(\d+)\]/);p&&i.push({type:"ref",num:p[1]})}else e[2]&&i.push({type:"latex",latex:e[2]});n=k}return n<f.length&&i.push({type:"text",text:X.parseInline(f.slice(n))}),i}function ct(f,i){const c=f.split(/\r?\n/),n=[];let e=[],t=!1,k="",p=[],E=!1,j=[],m=!1,h=[],I=!1,a=!1,P=[],q=!1,M=[];const x=()=>{if(e.length>0){const d=e.some(o=>o.endsWith("\\"));let g;d?g=e.map(o=>o.endsWith("\\")?o.slice(0,-1).trim():o.trim()).join("<br>").trim():g=e.join(" ").trim(),g&&n.push({type:"paragraph",tokens:O(g,i)})}e=[]},R=()=>{h.length>0&&n.push({type:"list",ordered:I,items:h.map(d=>O(d,i))}),h=[],m=!1,I=!1},C=()=>{if(P.length>0){let d,g=[...P];for(let l=g.length-1;l>=0;l--){const r=g[l].trim();if(r){r.startsWith("- ")&&(d=X.parseInline(r.substring(2).trim()),g=g.slice(0,l));break}}g.length===0&&d&&(g=[""]);const o=g.filter(l=>l.trim()!==""),$=o.length>1,u=g.some(l=>l.endsWith("\\"));let _,v,S=!1,N;if(u||$){const l=o[o.length-1];S=l?l.endsWith("\\"):!1,N=o.map(r=>{const B=r.endsWith("\\")?r.slice(0,-1).trim():r.trim();return O(B,i)}),_=o.map(r=>r.endsWith("\\")?r.slice(0,-1).trim():r.trim()).join(" ").trim(),v=!0}else _=g.join(" ").trim(),v=!1;const F=O(_,i);n.push({type:"blockquote",tokens:F,...N&&{paragraphs:N},multiline:v,endsWithBreak:S,...d&&{citation:d}})}P=[],a=!1},D=()=>{if(M.length>=3){const d=$=>{const u=$.split("|").map(_=>_.trim());return u[0]===""&&u.shift(),u.length>0&&u[u.length-1]===""&&u.pop(),u},g=d(M[0]),o=M.slice(2).map($=>d($));n.push({type:"table",headers:g,rows:o})}M=[],q=!1};for(let d=0;d<c.length;d++){const g=c[d]??"",o=g.replace(/\t/g,"    ");if(t){o.trim()==="```"?(n.push({type:"code",lang:k,code:p.join(`
`)}),t=!1,p=[],k=""):p.push(g);continue}if(E){const l=o.trim().match(/^\$\$(?:\s*\[(\d+)\])?$/);if(l){const r=l[1],B=j.join(`
`).replace(/\\_/g,"_");n.push({type:"latex",latex:B,...r&&{footnoteRef:r}}),E=!1,j=[]}else j.push(o);continue}const $=o.match(/^```(\w*)/);if($){x(),R(),C(),D(),t=!0,k=$[1]||"";continue}if(o.trim()==="$$"){x(),R(),C(),D(),E=!0;continue}const u=o.match(/^\s*!\[([^\]]*)\]\(([^)]+)\)\s*$/);if(u){x(),R(),C(),D();const l=(u[1]||"").trim(),r=(u[2]||"").trim();let B;if(d+1<c.length){const A=(c[d+1]??"").match(/^\s*[*_](.+)[*_]\s*$/);A&&(B=(A[1]||"").trim(),d++)}n.push({type:"image",path:r,alt:l||r,caption:B});continue}const _=o.match(/^\s*(?:-|\*|\+)\s+(.*)/);if(_){m||(x(),m=!0,I=!1),h.push((_[1]||"").trim());continue}const v=o.match(/^\s*\d+\.\s+(.*)/);if(v){m||(x(),m=!0,I=!0),h.push((v[1]||"").trim());continue}const S=o.match(/^\s{2,}(.*)/);if(m&&S&&(S[1]||"").trim()&&h.length>0){const l=h[h.length-1];l.endsWith("\\")?h[h.length-1]=l.slice(0,-1).trim()+"<br>"+(S[1]||"").trim():h[h.length-1]+=" "+(S[1]||"").trim();continue}m&&R();const N=o.match(/^>\s*(.*)$/);if(N){a||(x(),a=!0),P.push((N[1]||"").trim());continue}a&&C();const F=o.match(/^\s*\|.*\|\s*$/);if(F&&d+1<c.length){const l=c[d+1]??"";if(/^\s*\|[\s\-:|]+\|\s*$/.test(l)){q||(x(),R(),q=!0),M.push(o.trim());continue}}if(q&&F){M.push(o.trim());continue}if(q&&D(),o.trim()===""){x();continue}e.push(o.trim())}return x(),R(),C(),D(),n}function tt(f,i){const c=[];let n=[],e=!1,t=[],k=!1;const p=()=>{if(n.length>0){const j=n.some(h=>h.endsWith("\\"));let m;j?m=n.map(h=>h.endsWith("\\")?h.slice(0,-1).trim():h.trim()).join("<br>").trim():m=n.join(" ").trim(),m&&c.push({type:"paragraph",tokens:O(m,i)})}n=[]},E=()=>{t.length>0&&c.push({type:"list",ordered:k,items:t.map(j=>O(j,i))}),t=[],e=!1,k=!1};for(let j=0;j<f.length;j++){const m=f[j],h=m.match(/^\s*(?:-|\*|\+)\s+(.*)/);if(h){e||(p(),e=!0,k=!1),t.push((h[1]||"").trim());continue}const I=m.match(/^\s*\d+\.\s+(.*)/);if(I){e||(p(),e=!0,k=!0),t.push((I[1]||"").trim());continue}const a=m.match(/^\s{2,}(.*)/);if(e&&a&&(a[1]||"").trim()&&t.length>0){const P=t[t.length-1];P.endsWith("\\")?t[t.length-1]=P.slice(0,-1).trim()+"<br>"+(a[1]||"").trim():t[t.length-1]+=" "+(a[1]||"").trim();continue}if(e&&E(),m.trim()===""){p();continue}n.push(m)}return p(),E(),c}async function rt(f){if(!f)throw new Error("fetch is required to load essay index");const i=await f("/essays/index.json");if(!i.ok)throw new Error("Essay index not found");return await i.json()}async function at(f,i){if(!i)throw new Error("fetch is required to load essay markdown");const c=await i(`/essays/${f}.md`);if(!c.ok)throw new Error(`Essay "${f}" not found`);return await c.text()}async function ft(f,i){if(!i)return{};try{const c=await i(`/assets/essays/${f}/config.json`,{headers:{Accept:"application/json"}});return c.ok?(await c.json()).audio||{}:{}}catch{return{}}}const ht=async({params:f,fetch:i})=>{const{slug:c}=f;try{const e=(await rt(i)).find(E=>E.slug===c);if(!e)throw it(404,"Essay not found");const t=await at(c,i),k=e.hasConfig?await ft(c,i):{},p=lt(t,e.title,e.date,k);return{slug:c,post:p,publish:e.publish}}catch(n){throw n&&typeof n=="object"&&"status"in n?n:it(404,"Essay not found")}},dt=Object.freeze(Object.defineProperty({__proto__:null,load:ht},Symbol.toStringTag,{value:"Module"}));export{dt as _,ht as l};
